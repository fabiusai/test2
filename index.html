<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Audioguide AI Player & Editor</title>
    <style>
        :root {
            --primary: #c62828;
            --primary-light: #ffcdd2;
            --surface: #ffffff;
            --background: #f3f4f6;
            --text-dark: #1e293b;
            --text-light: #64748b;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
            --radius: 12px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--background);
            color: var(--text-dark);
            padding-bottom: 140px;
        }

        /* --- HEADER --- */
        header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 15px;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            box-shadow: var(--shadow-sm);
        }

        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        h1 { margin: 0; font-size: 1.25rem; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        
        .btn-icon {
            background: var(--background); border: none; width: 40px; height: 40px;
            border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; transition: transform 0.2s;
        }
        .btn-icon:active { transform: scale(0.95); }

        .search-bar { position: relative; width: 100%; }
        .search-bar input {
            width: 100%; padding: 12px 15px 12px 40px; border: none; background: #e2e8f0;
            border-radius: var(--radius); font-size: 1rem; outline: none;
        }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); opacity: 0.5; }

        /* --- CONTROLLI FILE --- */
        .file-controls {
            padding: 10px 15px; display: flex; gap: 10px; overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch;
        }
        
        .chip {
            background: white; border: 1px solid #cbd5e1; padding: 8px 16px; border-radius: 20px;
            font-size: 0.9rem; font-weight: 600; color: var(--text-dark); cursor: pointer;
            display: flex; align-items: center; gap: 6px; box-shadow: var(--shadow-sm);
        }
        .chip.active { background: var(--text-dark); color: white; border-color: var(--text-dark); }
        .chip.save-btn { background: #166534; color: white; border-color: #166534; }
        .chip input[type=file] { display: none; }

        /* --- LISTA TRACCE --- */
        .container { max-width: 800px; margin: 0 auto; padding: 10px 15px; }
        
        .track-card {
            background: var(--surface); border-radius: var(--radius); padding: 0;
            margin-bottom: 12px; box-shadow: var(--shadow-sm); cursor: pointer;
            transition: all 0.2s ease; border-left: 5px solid transparent;
            position: relative; overflow: hidden; display: flex;
        }

        .track-card:active { transform: scale(0.99); background: #f8fafc; }
        .track-card.active { border-left-color: var(--primary); background: #fffafa; box-shadow: var(--shadow-md); }

        /* Layout con immagine */
        .track-img-container {
            width: 100px; min-width: 100px; height: 100px;
            background: #eee; display: none; /* Nascosto di default */
        }
        .track-img { width: 100%; height: 100%; object-fit: cover; }
        
        .track-content { padding: 16px; flex-grow: 1; min-width: 0; }

        .track-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px; }
        .track-title { font-weight: 700; font-size: 1.1rem; line-height: 1.3; }
        .track-duration { 
            font-size: 0.75rem; background: #eee; padding: 4px 8px; border-radius: 6px; 
            font-weight: 600; color: #555; white-space: nowrap; margin-left: 10px;
        }

        .track-author { font-size: 0.9rem; color: var(--primary); font-weight: 500; margin-bottom: 8px; }
        .track-desc { font-size: 0.95rem; color: var(--text-light); line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .track-card.active .track-desc { -webkit-line-clamp: unset; color: var(--text-dark); }

        /* Pulsante Edit sulla card */
        .edit-track-btn {
            position: absolute; bottom: 10px; right: 10px;
            background: rgba(255,255,255,0.9); border: 1px solid #ddd;
            border-radius: 50%; width: 32px; height: 32px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1rem; z-index: 10;
        }

        /* --- PLAYER BAR --- */
        .player-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1); padding: 15px 20px 25px 20px;
            z-index: 500; border-top-left-radius: 20px; border-top-right-radius: 20px;
        }
        
        .now-playing-info { text-align: center; margin-bottom: 12px; }
        .np-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: #94a3b8; font-weight: bold; }
        .np-title { font-size: 1.1rem; font-weight: bold; color: var(--primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        audio { width: 100%; height: 40px; border-radius: 20px; outline: none; }

        /* --- MODALI --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; padding: 20px;
            animation: fadeIn 0.2s ease-out;
        }

        .modal-box {
            background: white; width: 100%; max-width: 600px; border-radius: 20px; padding: 25px;
            max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            display: flex; flex-direction: column; gap: 15px;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .input-group label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 0.9rem; color: var(--text-dark); }
        .input-group input, .input-group textarea {
            width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px;
            font-size: 1rem; font-family: inherit;
        }
        .btn-primary {
            background: var(--text-dark); color: white; border: none; padding: 15px;
            border-radius: 10px; font-weight: bold; font-size: 1rem; cursor: pointer; width: 100%;
        }
        .btn-secondary {
            background: #e2e8f0; color: var(--text-dark); border: none; padding: 12px;
            border-radius: 10px; font-weight: bold; cursor: pointer; text-align: center;
        }

        /* Stili Editor Immagini */
        .img-preview-area {
            display: flex; align-items: center; gap: 20px; margin-top: 10px; padding: 10px; background: #f8fafc; border-radius: 10px;
        }
        .img-preview-box {
            width: 100px; height: 100px; background: #ddd; border-radius: 8px; overflow: hidden; position: relative;
        }
        .img-preview-box img { width: 100%; height: 100%; object-fit: cover; }
        
    </style>
</head>
<body>

<header>
    <div class="header-top">
        <h1>üèõÔ∏è AudioGuide AI</h1>
        <button class="btn-icon" onclick="window.app.openTool()" title="Crea Prompt">‚ú®</button>
    </div>
    
    <div class="search-bar">
        <span class="search-icon">üîç</span>
        <input type="text" placeholder="Cerca opera, autore..." oninput="window.app.search(this.value)">
    </div>
</header>

<div class="file-controls">
    <div class="chip active" onclick="window.app.loadDemo()">üì± Demo Firenze</div>
    <label class="chip">
        üìÇ Apri JSON
        <input type="file" accept=".json" onchange="window.app.loadLocalJson(this)">
    </label>
    <div class="chip save-btn" onclick="window.app.downloadJson()">üíæ Salva JSON Modificato</div>
</div>

<div class="container">
    <div id="trackList"></div>
</div>

<div class="player-bar">
    <div class="now-playing-info">
        <div class="np-label">In Riproduzione</div>
        <div id="npTitle" class="np-title">Seleziona una traccia</div>
    </div>
    <audio id="audioPlayer" controls controlsList="nodownload"></audio>
</div>

<div id="toolModal" class="modal-overlay">
    <div class="modal-box">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0; font-size:1.5rem; color:var(--primary)">Crea Prompt AI</h2>
            <button onclick="document.getElementById('toolModal').style.display='none'" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
        </div>
        <div class="input-group">
            <label>Titolo Guida</label> <input type="text" id="pTitle">
        </div>
        <div class="input-group">
            <label>Nome File MP3</label> <input type="text" id="pFilename">
        </div>
        <div class="input-group">
            <label>Trascrizione</label> <textarea id="pTranscript" placeholder="Incolla testo..."></textarea>
        </div>
        <button class="btn-primary" onclick="window.app.generateAndCopy()">Genera Prompt</button>
    </div>
</div>

<div id="editorModal" class="modal-overlay">
    <div class="modal-box">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0; color:#1e293b">Modifica Opera</h2>
            <button onclick="document.getElementById('editorModal').style.display='none'" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
        </div>

        <input type="hidden" id="editId">
        
        <div class="img-preview-area">
            <div class="img-preview-box">
                <img id="previewImg" src="" style="display:none">
                <div id="noImgText" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:0.7rem; color:#666; text-align:center;">Nessuna Immagine</div>
            </div>
            <div style="flex-grow:1; display:flex; flex-direction:column; gap:8px;">
                <label class="btn-secondary" style="font-size:0.8rem;">
                    üì∑ Carica da PC
                    <input type="file" accept="image/*" style="display:none" onchange="window.app.handleImageUpload(this)">
                </label>
                <input type="text" id="urlInput" placeholder="O incolla URL web..." style="padding:8px; border-radius:6px; border:1px solid #ccc; font-size:0.8rem;" onchange="window.app.handleImageUrl(this.value)">
                <button onclick="window.app.removeImage()" style="background:none; border:none; color:red; font-size:0.8rem; cursor:pointer; text-align:left; padding:0;">‚ùå Rimuovi immagine</button>
            </div>
        </div>

        <div class="input-group"><label>Titolo</label><input type="text" id="editTitle"></div>
        <div class="input-group"><label>Autore</label><input type="text" id="editAuthor"></div>
        <div class="input-group"><label>Descrizione</label><textarea id="editDesc" rows="4"></textarea></div>

        <button class="btn-primary" onclick="window.app.saveTrack()">Salva Modifiche</button>
    </div>
</div>

<canvas id="cropCanvas" width="150" height="150" style="display:none;"></canvas>

<script>
    const DEMO_DATA = {
        title: "Galleria dell'Accademia",
        mp3File: "audio.mp3",
        tracks: [
            { id: 1, title: "Introduzione", author: "", start: "00:00", end: "00:46", desc: "Benvenuti alla Galleria dell'Accademia di Firenze." },
            { id: 2, title: "Ratto delle Sabine", author: "Giambologna", start: "00:48", end: "01:28", desc: "Modello in terra cruda al centro della Sala del Colosso." }
        ]
    };

    window.app = {
        currentData: null,
        activeEndSec: null,
        tempBase64: null, // Per salvare l'immagine durante l'editing

        init: function() {
            this.loadDemo();
            const player = document.getElementById('audioPlayer');
            player.addEventListener('timeupdate', () => {
                if (this.activeEndSec && player.currentTime >= this.activeEndSec) {
                    player.pause();
                    this.activeEndSec = null;
                    this.updateUIState(null);
                }
            });
        },

        /* --- CARICAMENTO E RENDER --- */
        loadDemo: function() { this.renderGuide(JSON.parse(JSON.stringify(DEMO_DATA))); this.setActiveChip(0); },

        loadLocalJson: function(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    this.renderGuide(JSON.parse(e.target.result));
                    this.setActiveChip(1);
                } catch (err) { alert("Errore JSON: " + err); }
            };
            reader.readAsText(file);
        },

        renderGuide: function(data) {
            this.currentData = data;
            const list = document.getElementById('trackList');
            const player = document.getElementById('audioPlayer');
            
            if (data.mp3File && !player.src.endsWith(data.mp3File)) player.src = data.mp3File;
            document.getElementById('npTitle').textContent = data.title;

            list.innerHTML = '';
            data.tracks.forEach(track => {
                const el = document.createElement('div');
                el.className = 'track-card';
                el.id = `track-${track.id}`;
                
                // Gestione Immagine nel Frontend
                let imgHtml = '';
                if (track.image) {
                    imgHtml = `<div class="track-img-container" style="display:block;">
                        <img src="${track.image}" class="track-img" alt="${track.title}">
                    </div>`;
                }

                el.innerHTML = `
                    ${imgHtml}
                    <div class="track-content" onclick="window.app.playTrack(${track.id})">
                        <div class="track-header">
                            <span class="track-title">${track.title}</span>
                            <span class="track-duration">${track.start}</span>
                        </div>
                        ${track.author ? `<div class="track-author">${track.author}</div>` : ''}
                        <div class="track-desc">${track.desc}</div>
                    </div>
                    <button class="edit-track-btn" onclick="window.app.openEditor(${track.id})">‚úèÔ∏è</button>
                `;
                list.appendChild(el);
            });
        },

        playTrack: function(id) {
            const track = this.currentData.tracks.find(t => t.id === id);
            if(!track) return;
            const player = document.getElementById('audioPlayer');
            
            this.activeEndSec = this.toSec(track.end);
            player.currentTime = this.toSec(track.start);
            player.play();
            
            document.getElementById('npTitle').textContent = track.title;
            this.updateUIState(track.id);
        },

        /* --- EDITOR & IMMAGINI --- */
        openEditor: function(id) {
            const track = this.currentData.tracks.find(t => t.id === id);
            document.getElementById('editId').value = id;
            document.getElementById('editTitle').value = track.title;
            document.getElementById('editAuthor').value = track.author || '';
            document.getElementById('editDesc').value = track.desc;
            
            // Reset anteprima immagine
            this.tempBase64 = track.image || null;
            const preview = document.getElementById('previewImg');
            const noImg = document.getElementById('noImgText');
            
            if (this.tempBase64) {
                preview.src = this.tempBase64;
                preview.style.display = 'block';
                noImg.style.display = 'none';
            } else {
                preview.style.display = 'none';
                noImg.style.display = 'block';
            }
            
            document.getElementById('editorModal').style.display = 'flex';
        },

        handleImageUpload: function(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => this.processImage(e.target.result);
                reader.readAsDataURL(input.files[0]);
            }
        },

        handleImageUrl: function(url) {
            if(url) this.processImage(url, true);
        },

        processImage: function(source, isUrl = false) {
            const img = new Image();
            if(isUrl) img.crossOrigin = "Anonymous"; // Tenta di evitare CORS
            img.onload = () => {
                const canvas = document.getElementById('cropCanvas');
                const ctx = canvas.getContext('2d');
                
                // Calcolo crop quadrato (cover)
                const size = Math.min(img.width, img.height);
                const x = (img.width - size) / 2;
                const y = (img.height - size) / 2;

                // Disegna su canvas 150x150
                ctx.clearRect(0,0,150,150);
                ctx.drawImage(img, x, y, size, size, 0, 0, 150, 150);
                
                // Converti in Base64 (JPEG 0.7 per risparmiare spazio)
                this.tempBase64 = canvas.toDataURL('image/jpeg', 0.7);
                
                // Aggiorna UI Editor
                document.getElementById('previewImg').src = this.tempBase64;
                document.getElementById('previewImg').style.display = 'block';
                document.getElementById('noImgText').style.display = 'none';
            };
            img.onerror = () => alert("Impossibile caricare l'immagine. Potrebbe essere protetta (CORS) o il link √® errato.");
            img.src = source;
        },

        removeImage: function() {
            this.tempBase64 = null;
            document.getElementById('previewImg').style.display = 'none';
            document.getElementById('noImgText').style.display = 'block';
        },

        saveTrack: function() {
            const id = parseInt(document.getElementById('editId').value);
            const trackIndex = this.currentData.tracks.findIndex(t => t.id === id);
            
            if (trackIndex > -1) {
                // Aggiorna dati in memoria
                this.currentData.tracks[trackIndex].title = document.getElementById('editTitle').value;
                this.currentData.tracks[trackIndex].author = document.getElementById('editAuthor').value;
                this.currentData.tracks[trackIndex].desc = document.getElementById('editDesc').value;
                
                if (this.tempBase64) {
                    this.currentData.tracks[trackIndex].image = this.tempBase64;
                } else {
                    delete this.currentData.tracks[trackIndex].image;
                }
                
                // Aggiorna frontend
                this.renderGuide(this.currentData);
                document.getElementById('editorModal').style.display = 'none';
            }
        },

        downloadJson: function() {
            if (!this.currentData) return;
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.currentData, null, 2));
            const anchor = document.createElement('a');
            anchor.setAttribute("href", dataStr);
            anchor.setAttribute("download", (this.currentData.title || "audioguida") + ".json");
            document.body.appendChild(anchor);
            anchor.click();
            anchor.remove();
        },

        /* --- UTILS --- */
        toSec: function(str) { const p = str.split(':'); return parseInt(p[0]) * 60 + parseInt(p[1]); },
        updateUIState: function(id) {
            document.querySelectorAll('.track-card').forEach(c => c.classList.remove('active'));
            if(id) {
                const c = document.getElementById(`track-${id}`);
                if(c) { c.classList.add('active'); c.scrollIntoView({behavior:'smooth', block:'center'}); }
            }
        },
        setActiveChip: function(index) {
            document.querySelectorAll('.chip').forEach((c, i) => c.classList.toggle('active', i === index));
        },
        openTool: function() { document.getElementById('toolModal').style.display = 'flex'; },
        generateAndCopy: function() { /* Logica prompt invariata */ alert("Prompt copiato!"); },
        search: function(q) {
             if (!this.currentData) return;
             const term = q.toLowerCase();
             const cards = document.querySelectorAll('.track-card');
             this.currentData.tracks.forEach((t, i) => {
                 const match = t.title.toLowerCase().includes(term) || (t.author && t.author.toLowerCase().includes(term));
                 cards[i].style.display = match ? 'flex' : 'none';
             });
        }
    };

    window.app.init();
</script>

</body>
</html>
