<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Audioguide AI Player</title>
    <style>
        :root {
            --primary: #c62828; /* Rosso Museale */
            --primary-light: #ffcdd2;
            --surface: #ffffff;
            --background: #f3f4f6;
            --text-dark: #1e293b;
            --text-light: #64748b;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
            --radius: 12px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--background);
            color: var(--text-dark);
            padding-bottom: 140px; /* Spazio per il player */
        }

        /* --- HEADER --- */
        header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 15px;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            box-shadow: var(--shadow-sm);
        }

        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        h1 { margin: 0; font-size: 1.25rem; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        
        .btn-icon {
            background: var(--background);
            border: none;
            width: 40px; height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem;
            transition: transform 0.2s;
        }
        .btn-icon:active { transform: scale(0.95); }

        .search-bar { position: relative; width: 100%; }
        .search-bar input {
            width: 100%;
            padding: 12px 15px 12px 40px;
            border: none;
            background: #e2e8f0;
            border-radius: var(--radius);
            font-size: 1rem;
            outline: none;
        }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); opacity: 0.5; }

        /* --- CONTROLLI FILE --- */
        .file-controls {
            padding: 10px 15px;
            display: flex;
            gap: 10px;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
        }
        
        .chip {
            background: white;
            border: 1px solid #cbd5e1;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-dark);
            cursor: pointer;
            display: flex; align-items: center; gap: 6px;
            box-shadow: var(--shadow-sm);
        }
        .chip.active { background: var(--text-dark); color: white; border-color: var(--text-dark); }
        .chip input[type=file] { display: none; }

        /* --- LISTA TRACCE --- */
        .container { max-width: 800px; margin: 0 auto; padding: 10px 15px; }
        
        .track-card {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 5px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .track-card:active { transform: scale(0.99); background: #f8fafc; }
        
        .track-card.active { 
            border-left-color: var(--primary); 
            background: #fffafa;
            box-shadow: var(--shadow-md);
        }

        .track-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px; }
        .track-title { font-weight: 700; font-size: 1.1rem; line-height: 1.3; }
        .track-duration { 
            font-size: 0.75rem; 
            background: #eee; 
            padding: 4px 8px; 
            border-radius: 6px; 
            font-weight: 600; 
            color: #555;
            white-space: nowrap;
            margin-left: 10px;
        }

        .track-author { font-size: 0.9rem; color: var(--primary); font-weight: 500; margin-bottom: 8px; }
        .track-desc { font-size: 0.95rem; color: var(--text-light); line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        .track-card.active .track-desc { -webkit-line-clamp: unset; color: var(--text-dark); }

        /* --- PLAYER BAR --- */
        .player-bar {
            position: fixed;
            bottom: 0; left: 0; width: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            padding: 15px 20px 25px 20px;
            z-index: 500;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
        }
        
        .now-playing-info { text-align: center; margin-bottom: 12px; }
        .np-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: #94a3b8; font-weight: bold; }
        .np-title { font-size: 1.1rem; font-weight: bold; color: var(--primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        audio { width: 100%; height: 40px; border-radius: 20px; outline: none; }
        audio::-webkit-media-controls-panel { background-color: #f1f5f9; }

        /* --- MODALE --- */
        .modal-overlay {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            align-items: center; justify-content: center;
            padding: 20px;
            animation: fadeIn 0.2s ease-out;
        }

        .modal-box {
            background: white;
            width: 100%; max-width: 600px;
            border-radius: 20px;
            padding: 25px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            display: flex; flex-direction: column; gap: 15px;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .input-group label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 0.9rem; color: var(--text-dark); }
        .input-group input, .input-group textarea {
            width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px;
            font-size: 1rem; font-family: inherit;
        }
        .input-group textarea { resize: vertical; min-height: 100px; }

        .btn-primary {
            background: var(--text-dark); color: white; border: none; padding: 15px;
            border-radius: 10px; font-weight: bold; font-size: 1rem; cursor: pointer;
            width: 100%; margin-top: 10px;
        }
        .btn-primary:active { transform: translateY(1px); }

        .prompt-preview {
            background: #1e293b; color: #a5b4fc; 
            padding: 15px; border-radius: 8px; 
            font-family: monospace; font-size: 0.85rem; 
            white-space: pre-wrap; word-break: break-all;
            max-height: 150px; overflow-y: auto;
            display: none;
        }
        
    </style>
</head>
<body>

<header>
    <div class="header-top">
        <h1>üèõÔ∏è AudioGuide AI</h1>
        <button class="btn-icon" onclick="window.app.openTool()" title="Crea Prompt">
            ‚ú®
        </button>
    </div>
    
    <div class="search-bar">
        <span class="search-icon">üîç</span>
        <input type="text" placeholder="Cerca opera, autore..." oninput="window.app.search(this.value)">
    </div>
</header>

<div class="file-controls">
    <div class="chip active" onclick="window.app.loadDemo()">
        üì± Demo Firenze
    </div>
    <label class="chip">
        üìÇ Carica JSON
        <input type="file" accept=".json" onchange="window.app.loadLocalJson(this)">
    </label>
</div>

<div class="container">
    <div id="trackList"></div>
</div>

<div class="player-bar">
    <div class="now-playing-info">
        <div class="np-label">In Riproduzione</div>
        <div id="npTitle" class="np-title">Seleziona una traccia</div>
    </div>
    <audio id="audioPlayer" controls controlsList="nodownload"></audio>
</div>

<div id="toolModal" class="modal-overlay">
    <div class="modal-box">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0; font-size:1.5rem; color:var(--primary)">Crea Nuova Guida</h2>
            <button onclick="document.getElementById('toolModal').style.display='none'" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
        </div>
        
        <p style="color:var(--text-light); font-size:0.9rem; margin:0;">
            Inserisci i dati qui sotto. L'app generer√† un prompt perfetto da inviare all'Intelligenza Artificiale.
        </p>

        <div class="input-group">
            <label>Titolo Guida</label>
            <input type="text" id="pTitle" placeholder="es. Museo Egizio Torino">
        </div>
        <div class="input-group">
            <label>Nome File Audio MP3</label>
            <input type="text" id="pFilename" placeholder="es. audio_torino.mp3">
        </div>
        <div class="input-group">
            <label>Trascrizione e Tempi (da Turboscribe/Whisper)</label>
            <textarea id="pTranscript" placeholder="Incolla qui il testo con i timestamp (00:00)..."></textarea>
        </div>

        <button class="btn-primary" onclick="window.app.generateAndCopy()">üìã Genera e Copia Prompt</button>
        
        <div id="promptResult" class="prompt-preview"></div>
    </div>
</div>

<script>
    /* --- DATI DEMO --- */
    const DEMO_DATA = {
        title: "Galleria dell'Accademia",
        mp3File: "audio.mp3",
        tracks: [
            { id: 1, title: "Introduzione", author: "", start: "00:00", end: "00:46", desc: "Benvenuti alla Galleria dell'Accademia di Firenze. Questo museo non √® solo la casa del David, ma uno scrigno che racchiude secoli di storia." },
            { id: 2, title: "Ratto delle Sabine", author: "Giambologna", start: "00:48", end: "01:28", desc: "Modello in terra cruda al centro della Sala del Colosso. Notate la forma serpentinata dei tre corpi che si avvitano verso l'alto." },
            { id: 3, title: "Madonna col Bambino", author: "Sandro Botticelli", start: "01:30", end: "02:11", desc: "Detta 'Madonna del Mare'. Osservate la delicatezza del volto e la melagrana, simbolo della passione." },
            { id: 4, title: "Cassone Adimari", author: "Lo Scheggia", start: "02:13", end: "02:56", desc: "Pannello frontale di un cassone nuziale che raffigura un corteo nel cuore di Firenze con il Battistero sullo sfondo." },
            { id: 5, title: "Schiavo Giovane", author: "Michelangelo", start: "04:30", end: "05:10", desc: "Il primo dei prigioni. Le ginocchia piegate suggeriscono lo sforzo di alzarsi. Il 'non finito' mostra la tecnica scultorea." },
            { id: 6, title: "David", author: "Michelangelo", start: "08:44", end: "09:33", desc: "Il capolavoro assoluto. David √® ritratto nell'attimo di concentrazione prima dello scontro con Golia. Simbolo della virt√π civica." }
        ]
    };

    window.app = {
        currentData: null,
        activeEndSec: null,

        init: function() {
            this.loadDemo();
            
            // Gestione Stop Automatico
            const player = document.getElementById('audioPlayer');
            player.addEventListener('timeupdate', () => {
                if (this.activeEndSec && player.currentTime >= this.activeEndSec) {
                    player.pause();
                    this.activeEndSec = null; // Reset
                    this.updateUIState(null); // Rimuovi highlight
                }
            });
        },

        /* --- LOGICA DI NAVIGAZIONE --- */
        loadDemo: function() {
            this.renderGuide(DEMO_DATA);
            this.setActiveChip(0);
        },

        loadLocalJson: function(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    this.renderGuide(data);
                    this.setActiveChip(1);
                } catch (err) {
                    alert("Errore nel file JSON: " + err);
                }
            };
            reader.readAsText(file);
        },

        renderGuide: function(data) {
            this.currentData = data;
            const list = document.getElementById('trackList');
            const player = document.getElementById('audioPlayer');
            
            // Setup Player
            if (data.mp3File && !player.src.endsWith(data.mp3File)) {
                player.src = data.mp3File;
            }
            document.getElementById('npTitle').textContent = data.title;

            // Render Lista
            list.innerHTML = '';
            data.tracks.forEach(track => {
                const el = document.createElement('div');
                el.className = 'track-card';
                el.id = `track-${track.id}`;
                el.onclick = () => this.playTrack(track);
                
                el.innerHTML = `
                    <div class="track-header">
                        <span class="track-title">${track.title}</span>
                        <span class="track-duration">${track.start}</span>
                    </div>
                    ${track.author ? `<div class="track-author">${track.author}</div>` : ''}
                    <div class="track-desc">${track.desc}</div>
                `;
                list.appendChild(el);
            });
        },

        playTrack: function(track) {
            const player = document.getElementById('audioPlayer');
            const startSec = this.toSec(track.start);
            this.activeEndSec = this.toSec(track.end);

            player.currentTime = startSec;
            player.play();
            
            // Aggiorna UI Player Bar
            document.getElementById('npTitle').textContent = track.title;
            
            // Aggiorna UI Lista
            this.updateUIState(track.id);
        },

        updateUIState: function(activeId) {
            document.querySelectorAll('.track-card').forEach(c => c.classList.remove('active'));
            if (activeId) {
                const activeCard = document.getElementById(`track-${activeId}`);
                if (activeCard) {
                    activeCard.classList.add('active');
                    // Scroll dolce verso la card
                    activeCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            } else {
                document.getElementById('npTitle').textContent = this.currentData.title;
            }
        },

        search: function(query) {
            if (!this.currentData) return;
            const term = query.toLowerCase();
            const cards = document.querySelectorAll('.track-card');
            
            this.currentData.tracks.forEach((t, i) => {
                const match = t.title.toLowerCase().includes(term) || 
                              (t.author && t.author.toLowerCase().includes(term)) || 
                              t.desc.toLowerCase().includes(term);
                cards[i].style.display = match ? 'block' : 'none';
            });
        },

        /* --- TOOL GENERATORE PROMPT --- */
        openTool: function() {
            document.getElementById('toolModal').style.display = 'flex';
        },

        generateAndCopy: function() {
            const title = document.getElementById('pTitle').value || "[Titolo]";
            const file = document.getElementById('pFilename').value || "[file.mp3]";
            const transcript = document.getElementById('pTranscript').value || "[testo]";

            const prompt = `Sei un assistente per audioguide. Crea un file JSON valido basato su questi dati.

DATI DI INPUT:
- Titolo Guida: "${title}"
- File Audio: "${file}"
- Trascrizione:
"""
${transcript}
"""

ISTRUZIONI:
1. Crea un array "tracks".
2. Ogni traccia deve avere: "id", "title", "author" (se presente), "start" (MM:SS inizio), "end" (MM:SS fine), "desc" (testo pulito).
3. "start" √® il tempo del titolo dell'opera. "end" √® il tempo di "Fine descrizione" o l'inizio della successiva.

OUTPUT JSON:
{
  "title": "${title}",
  "mp3File": "${file}",
  "tracks": [ ... ]
}`;

            // Mostra anteprima e copia
            const preview = document.getElementById('promptResult');
            preview.style.display = 'block';
            preview.textContent = "Prompt copiato! Incollalo ora nella chat AI.";
            
            navigator.clipboard.writeText(prompt);
            alert("Prompt copiato negli appunti! Ora incollalo su ChatGPT.");
        },

        /* --- UTILITY --- */
        toSec: function(str) {
            const p = str.split(':');
            return parseInt(p[0]) * 60 + parseInt(p[1]);
        },
        
        setActiveChip: function(index) {
            document.querySelectorAll('.chip').forEach((c, i) => {
                c.classList.toggle('active', i === index);
            });
        }
    };

    window.app.init();
</script>

</body>
</html>
