<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audioguide Player Pro</title>
    <style>
        :root {
            --primary: #b71c1c;
            --bg-color: #f5f5f5;
            --card-bg: #ffffff;
            --text-main: #212121;
            --text-sec: #666;
            --border: #ddd;
        }

        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        body { margin: 0; background-color: var(--bg-color); color: var(--text-main); padding-bottom: 160px; }

        /* HEADER & CONTROLS */
        header {
            background: white; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: sticky; top: 0; z-index: 100; display: flex; flex-direction: column; gap: 10px;
        }

        .header-top { display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 1.2rem; color: var(--primary); }
        
        .btn-tool {
            background: #eee; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 0.9rem;
        }
        .btn-tool:hover { background: #ddd; }

        /* SELEZIONE GUIDA */
        .controls-area { display: flex; gap: 10px; flex-wrap: wrap; }
        
        select.guide-selector {
            flex-grow: 1; padding: 10px; border: 1px solid var(--border); border-radius: 5px; font-size: 1rem;
        }

        .file-btn-wrapper { position: relative; overflow: hidden; display: inline-block; }
        .file-btn {
            border: 1px solid var(--primary); color: var(--primary); background: white; 
            padding: 10px 15px; border-radius: 5px; cursor: pointer; font-weight: bold;
        }
        .file-btn-wrapper input[type=file] {
            font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer;
        }

        /* RICERCA */
        .search-container { padding: 10px 15px; background: var(--bg-color); position: sticky; top: 125px; z-index: 90; }
        #searchInput { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 25px; outline: none; }
        #searchInput:focus { border-color: var(--primary); box-shadow: 0 0 5px rgba(183,28,28,0.2); }

        /* LISTA TRACCE */
        .container { max-width: 800px; margin: 0 auto; padding: 0 15px; }
        .track-list { list-style: none; padding: 0; }
        
        .track-card {
            background: var(--card-bg); border-radius: 10px; padding: 15px; margin-bottom: 10px;
            box-shadow: 0 2px 3px rgba(0,0,0,0.05); cursor: pointer; border-left: 5px solid transparent;
            transition: transform 0.2s;
        }
        .track-card:hover { transform: translateY(-2px); }
        .track-card.active { border-left-color: var(--primary); background-color: #fff3e0; }

        .card-head { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 5px; }
        .t-time { background: #eee; padding: 2px 8px; border-radius: 5px; font-size: 0.85rem; height: fit-content;}
        .t-title { color: var(--primary); font-size: 1.05rem; }
        .t-auth { font-style: italic; font-size: 0.9rem; color: var(--text-sec); margin-bottom: 5px; }
        .t-desc { font-size: 0.95rem; line-height: 1.4; color: #444; }

        /* PLAYER FISSO */
        .player-bar {
            position: fixed; bottom: 0; left: 0; right: 0; background: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1); padding: 15px; z-index: 1000; text-align: center;
        }
        .now-playing { font-weight: bold; color: var(--primary); margin-bottom: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        audio { width: 100%; max-width: 800px; }

        /* MODALE CREATOR */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center;
        }
        .modal-box {
            background: white; width: 90%; max-width: 600px; padding: 20px; border-radius: 10px;
            max-height: 90vh; overflow-y: auto;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close-modal { background: none; border: none; font-size: 1.5rem; cursor: pointer; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-weight: bold; margin-bottom: 5px; }
        .form-group input, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .form-group textarea { height: 150px; font-family: monospace; font-size: 0.9rem; }
        
        .btn-action {
            background: var(--primary); color: white; border: none; padding: 10px 20px; 
            border-radius: 5px; cursor: pointer; font-size: 1rem; width: 100%; margin-top: 10px;
        }
        .btn-secondary { background: #555; margin-top: 5px; }

        /* Feedback */
        .empty-state { text-align: center; padding: 40px; color: #999; }
    </style>
</head>
<body>

<header>
    <div class="header-top">
        <h1 id="appTitle">Audioguide Player</h1>
        <button class="btn-tool" onclick="openModal()">‚öôÔ∏è Crea / Converti</button>
    </div>
    
    <div class="controls-area">
        <select id="guideSelector" class="guide-selector">
            <option value="" disabled selected>-- Seleziona una guida --</option>
            </select>

        <div class="file-btn-wrapper">
            <button class="file-btn">üìÇ Apri JSON</button>
            <input type="file" id="jsonInput" accept=".json">
        </div>
    </div>
</header>

<div class="search-container">
    <input type="text" id="searchInput" placeholder="Cerca opera, autore...">
</div>

<div class="container">
    <ul id="trackList" class="track-list">
        <div class="empty-state">
            Seleziona una guida dal menu o carica un file JSON.<br><br>
            Usa il tasto ‚öôÔ∏è per convertire un file TXT in JSON.
        </div>
    </ul>
</div>

<div class="player-bar">
    <div class="now-playing" id="trackLabel">Nessuna traccia selezionata</div>
    <audio id="audioPlayer" controls controlsList="nodownload">
        Il tuo browser non supporta l'audio.
    </audio>
</div>

<div class="modal-overlay" id="creatorModal">
    <div class="modal-box">
        <div class="modal-header">
            <h3>Convertitore TXT ‚Üí JSON</h3>
            <button class="close-modal" onclick="closeModal()">√ó</button>
        </div>

        <div class="form-group">
            <label>1. Titolo della Guida (Apparir√† nell'App)</label>
            <input type="text" id="newGuideTitle" placeholder="Es: Galleria dell'Accademia">
        </div>

        <div class="form-group">
            <label>2. Nome File MP3 (Esatto, con estensione)</label>
            <input type="text" id="newMp3Name" placeholder="Es: audio_firenze.mp3">
            <small style="color:#666">Il file audio dovr√† trovarsi nella stessa cartella del JSON.</small>
        </div>

        <div class="form-group">
            <label>3. Incolla il testo (Formato con 00:00)</label>
            <textarea id="txtContent" placeholder="00:00 Introduzione..."></textarea>
            <div style="margin-top:5px; text-align:right;">
                <input type="file" id="txtFileInput" accept=".txt" style="display:none">
                <button type="button" onclick="document.getElementById('txtFileInput').click()" style="font-size:0.8rem; padding:4px 8px;">O carica file .txt</button>
            </div>
        </div>

        <button class="btn-action" onclick="generateAndDownload()">üíæ Scarica JSON</button>
        <div id="convertStatus" style="margin-top:10px; text-align:center; font-size:0.9rem;"></div>
    </div>
</div>

<script>
    /* =========================================
       CONFIGURAZIONE MANIFEST (Opzionale)
       Se usi GitHub, elenca qui i file JSON disponibili
       ========================================= */
    const AVAILABLE_GUIDES = [
        // { name: "Galleria Accademia", file: "accademia.json" },
        // { name: "Uffizi", file: "uffizi.json" }
    ];

    /* =========================================
       LOGICA PLAYER
       ========================================= */
    let currentTracks = [];
    const player = document.getElementById('audioPlayer');
    const trackLabel = document.getElementById('trackLabel');
    const listEl = document.getElementById('trackList');
    const appTitle = document.getElementById('appTitle');

    // 1. Inizializzazione Dropdown
    const selector = document.getElementById('guideSelector');
    if (AVAILABLE_GUIDES.length > 0) {
        AVAILABLE_GUIDES.forEach(g => {
            const opt = document.createElement('option');
            opt.value = g.file;
            opt.textContent = g.name;
            selector.appendChild(opt);
        });
    } else {
        const opt = document.createElement('option');
        opt.textContent = "Nessuna guida pre-configurata (Usa 'Apri JSON')";
        selector.appendChild(opt);
    }

    // 2. Evento cambio Dropdown (Fetch da server/github)
    selector.addEventListener('change', (e) => {
        const file = e.target.value;
        if(!file) return;
        
        fetch(file)
            .then(res => res.json())
            .then(data => loadGuide(data))
            .catch(err => alert("Errore caricamento: " + err));
    });

    // 3. Evento caricamento manuale JSON (Locale)
    document.getElementById('jsonInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (ev) => {
            try {
                const data = JSON.parse(ev.target.result);
                loadGuide(data);
                // Resetta select
                selector.value = "";
            } catch (err) {
                alert("File JSON non valido.");
            }
        };
        reader.readAsText(file);
    });

    // 4. Caricamento Dati nel Player
    function loadGuide(data) {
        // Imposta Titolo e Audio
        appTitle.textContent = data.title || "Audioguida";
        player.src = data.mp3File; // Cambia la sorgente audio
        currentTracks = data.tracks;
        
        renderList(currentTracks);
        player.load(); // Ricarica player con nuovo audio
        trackLabel.textContent = "Premi Play per iniziare";
    }

    // 5. Rendering Lista
    function renderList(tracks) {
        listEl.innerHTML = '';
        if (!tracks || tracks.length === 0) {
            listEl.innerHTML = '<div class="empty-state">Nessuna traccia trovata nel file.</div>';
            return;
        }

        tracks.forEach(t => {
            const li = document.createElement('li');
            li.className = 'track-card';
            li.dataset.sec = t.seconds;
            li.onclick = () => playTrack(t);
            li.innerHTML = `
                <div class="card-head">
                    <span class="t-title">${t.title}</span>
                    <span class="t-time">${t.time}</span>
                </div>
                ${t.author ? `<div class="t-auth">${t.author}</div>` : ''}
                <div class="t-desc">${t.desc}</div>
            `;
            listEl.appendChild(li);
        });
    }

    function playTrack(track) {
        player.currentTime = track.seconds;
        player.play().catch(e => console.log(e));
        updateActiveUI(track);
    }

    function updateActiveUI(track) {
        trackLabel.textContent = `${track.time} - ${track.title}`;
        document.querySelectorAll('.track-card').forEach(c => c.classList.remove('active'));
        const active = document.querySelector(`.track-card[data-sec="${track.seconds}"]`);
        if(active) {
            active.classList.add('active');
            active.scrollIntoView({behavior: "smooth", block: "center"});
        }
    }

    player.addEventListener('timeupdate', () => {
        const cur = player.currentTime;
        const track = [...currentTracks].reverse().find(t => t.seconds <= cur + 1);
        if(track) {
            const active = document.querySelector('.track-card.active');
            if (!active || active.dataset.sec != track.seconds) updateActiveUI(track);
        }
    });

    // Ricerca
    document.getElementById('searchInput').addEventListener('input', (e) => {
        const q = e.target.value.toLowerCase();
        if(!currentTracks.length) return;
        
        const filtered = currentTracks.filter(t => 
            t.title.toLowerCase().includes(q) || 
            (t.author && t.author.toLowerCase().includes(q)) ||
            t.desc.toLowerCase().includes(q)
        );
        renderList(filtered);
    });

    /* =========================================
       LOGICA CREATOR / CONVERTER
       ========================================= */
    function openModal() { document.getElementById('creatorModal').style.display = 'flex'; }
    function closeModal() { document.getElementById('creatorModal').style.display = 'none'; }

    // Carica TXT nella textarea
    document.getElementById('txtFileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => document.getElementById('txtContent').value = ev.target.result;
        reader.readAsText(file);
    });

    function generateAndDownload() {
        const rawText = document.getElementById('txtContent').value;
        const title = document.getElementById('newGuideTitle').value || "Nuova Audioguida";
        const mp3Name = document.getElementById('newMp3Name').value || "audio.mp3";
        const status = document.getElementById('convertStatus');

        if(!rawText.trim()) { alert("Inserisci il testo da convertire!"); return; }

        // Parsing
        const tracks = parseTxtToTracks(rawText);
        
        if(tracks.length === 0) {
            status.innerHTML = "<span style='color:red'>Errore: Nessuna traccia trovata. Verifica il formato.</span>";
            return;
        }

        // Struttura JSON Finale
        const guideData = {
            title: title,
            mp3File: mp3Name,
            generatedAt: new Date().toISOString(),
            tracks: tracks
        };

        // Creazione File Download
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(guideData, null, 2));
        const downloadAnchor = document.createElement('a');
        downloadAnchor.setAttribute("href", dataStr);
        downloadAnchor.setAttribute("download", title.replace(/[^a-z0-9]/gi, '_').toLowerCase() + ".json");
        document.body.appendChild(downloadAnchor);
        downloadAnchor.click();
        downloadAnchor.remove();

        status.innerHTML = `<span style='color:green'>‚úÖ File JSON creato con ${tracks.length} tracce!</span>`;
    }

    // Engine di Parsing (Lo stesso usato precedentemente)
    function parseTxtToTracks(text) {
        const cleanText = text.replace(/\/g, "");
        const chunkRegex = /(\d{2}:\d{2})([\s\S]*?)(?=(\d{2}:\d{2})|$)/g;
        let match;
        const tracks = [];
        let idCounter = 1;

        while ((match = chunkRegex.exec(cleanText)) !== null) {
            const timeStr = match[1];
            const content = match[2].trim();
            let title = "Capitolo " + idCounter;
            let author = "";
            let desc = content;

            const meta = content.match(/Titolo Opera:\s*(.*?)\s*Autore dell'Opera:\s*(.*?)\s([\s\S]*)/i);
            if (meta) {
                title = meta[1].trim();
                author = meta[2].trim();
                desc = meta[3].replace(/Fine Descrizione.*/i, "").trim();
            } else if (content.toLowerCase().includes("introduzione")) {
                title = "Introduzione";
                desc = content.replace(/Fine Introduzione.*/i, "").trim();
            }

            if(desc.length > 5) {
                tracks.push({
                    id: idCounter++,
                    time: timeStr,
                    seconds: parseInt(timeStr.split(':')[0])*60 + parseInt(timeStr.split(':')[1]),
                    title: title,
                    author: author,
                    desc: desc
                });
            }
        }
        return tracks;
    }
</script>

</body>
</html>
