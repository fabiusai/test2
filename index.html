<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audioguide Player Pro</title>
    <style>
        :root {
            --primary: #b71c1c;
            --bg-color: #f4f4f4;
            --text-main: #212121;
        }
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        body { margin: 0; background-color: var(--bg-color); color: var(--text-main); padding-bottom: 150px; }

        /* HEADER */
        header { background: white; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        .header-content { max-width: 800px; margin: 0 auto; display: flex; flex-direction: column; gap: 15px; }
        .top-row { display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 1.3rem; color: var(--primary); }
        .btn-tool { background: #eee; border: 1px solid #ccc; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .btn-tool:hover { background: #e0e0e0; }

        /* CONTROLLI */
        .controls-row { display: flex; gap: 10px; }
        select#guideSelector { flex: 1; padding: 10px; border-radius: 6px; border: 1px solid #ccc; }
        .upload-wrapper { position: relative; overflow: hidden; }
        .btn-upload { border: 1px solid var(--primary); background: white; color: var(--primary); padding: 10px 15px; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .upload-wrapper input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; }

        /* LISTA E PLAYER */
        .container { max-width: 800px; margin: 0 auto; padding: 15px; }
        .track-list { list-style: none; padding: 0; margin: 0; }
        .track-card { background: white; border-radius: 8px; padding: 15px; margin-bottom: 10px; cursor: pointer; border-left: 4px solid transparent; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .track-card.active { border-left-color: var(--primary); background-color: #fffde7; }
        .card-top { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 5px; }
        .t-time { background: #eee; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; }
        .player-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: white; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); padding: 15px; text-align: center; z-index: 1000; }
        .now-playing { font-weight: bold; color: var(--primary); margin-bottom: 8px; }
        audio { width: 100%; max-width: 800px; }

        /* MODALE */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; }
        .modal-box { background: white; width: 90%; max-width: 600px; padding: 20px; border-radius: 10px; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .form-group label { display: block; font-weight: bold; margin-bottom: 5px; }
        .form-group input, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        .form-group textarea { height: 150px; font-family: monospace; }
        .btn-primary { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; width: 100%; font-size: 1rem; }
        #convertStatus { text-align: center; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>

<header>
    <div class="header-content">
        <div class="top-row">
            <h1>Audioguide Player</h1>
            <button class="btn-tool" onclick="window.app.openModal()">‚öôÔ∏è Crea Guida</button>
        </div>
        <div class="controls-row">
            <select id="guideSelector" onchange="window.app.loadRemoteGuide(this.value)">
                <option value="" disabled selected>-- Scegli Guida --</option>
            </select>
            <div class="upload-wrapper">
                <button class="btn-upload">üìÇ Apri JSON</button>
                <input type="file" onchange="window.app.loadLocalJson(this)" accept=".json">
            </div>
        </div>
        <input type="text" id="searchInput" placeholder="üîç Cerca..." style="width:100%; padding:10px; border:1px solid #ddd; border-radius:5px;" oninput="window.app.search(this.value)">
    </div>
</header>

<div class="container">
    <ul id="trackList" class="track-list">
        <div style="text-align:center; padding:40px; color:#888;">
            Carica un JSON o crea una nuova guida.
        </div>
    </ul>
</div>

<div class="player-bar">
    <div id="trackLabel" class="now-playing">Seleziona una traccia</div>
    <audio id="audioPlayer" controls controlsList="nodownload"></audio>
</div>

<div id="creatorModal" class="modal-overlay">
    <div class="modal-box">
        <div style="display:flex; justify-content:space-between;">
            <h3>Nuova Guida</h3>
            <button onclick="window.app.closeModal()" style="border:none; background:none; font-size:1.5rem; cursor:pointer;">√ó</button>
        </div>
        <div class="form-group">
            <label>Titolo Guida</label>
            <input type="text" id="newGuideTitle" placeholder="Es: Uffizi">
        </div>
        <div class="form-group">
            <label>File MP3 (esatto)</label>
            <input type="text" id="newMp3Name" placeholder="Es: audio.mp3">
        </div>
        <div class="form-group">
            <label>Testo (copia/incolla)</label>
            <textarea id="txtContent" placeholder="00:00 Introduzione..."></textarea>
            <div style="text-align:right; margin-top:5px;">
                <button onclick="document.getElementById('txtFileLoader').click()" class="btn-tool" style="font-size:0.8rem;">Carica .txt</button>
                <input type="file" id="txtFileLoader" style="display:none" onchange="window.app.loadTxtContent(this)" accept=".txt">
            </div>
        </div>
        <button class="btn-primary" onclick="window.app.generateJson()">üíæ Scarica JSON</button>
        <div id="convertStatus"></div>
    </div>
</div>

<script>
    window.app = {
        currentTracks: [],
        
        openModal: function() {
            document.getElementById('creatorModal').style.display = 'flex';
            document.getElementById('convertStatus').innerHTML = '';
        },

        closeModal: function() {
            document.getElementById('creatorModal').style.display = 'none';
        },

        loadTxtContent: function(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => document.getElementById('txtContent').value = e.target.result;
            reader.readAsText(file);
        },

        // --- MOTORE "NO-REGEX" (Manipolazione Stringhe Pura) ---
        generateJson: function() {
            const status = document.getElementById('convertStatus');
            try {
                let rawText = document.getElementById('txtContent').value;
                const title = document.getElementById('newGuideTitle').value || "Nuova Audioguida";
                const mp3 = document.getElementById('newMp3Name').value || "audio.mp3";

                if (!rawText || rawText.length < 5) {
                    status.innerHTML = "<span style='color:red'>Errore: Testo vuoto!</span>";
                    return;
                }

                // 1. Pulizia senza Regex
                // Cicla finch√© trova "", start);
                    if (end !== -1) {
                        // Rimuove la parte tra [ e ]
                        rawText = rawText.substring(0, start) + rawText.substring(end + 1);
                    } else {
                        break; // Break di sicurezza
                    }
                }

                // 2. Trova tutti gli orari (MM:SS) manualmente
                // Scansiona il testo carattere per carattere cercando i due punti :
                const chunks = [];
                let lastIndex = 0;
                let lastTime = null;

                for (let i = 0; i < rawText.length - 4; i++) {
                    if (rawText[i + 2] === ':') {
                        // Controlla se i caratteri intorno sono numeri
                        let h1 = rawText[i];
                        let h2 = rawText[i+1];
                        let m1 = rawText[i+3];
                        let m2 = rawText[i+4];

                        if (!isNaN(h1) && !isNaN(h2) && !isNaN(m1) && !isNaN(m2) && h1 !== ' ' && m2 !== ' ') {
                            // Trovato orario!
                            let currentTime = rawText.substring(i, i + 5);
                            
                            // Se avevamo un orario precedente, salviamo il blocco di testo tra il precedente e questo
                            if (lastTime !== null) {
                                let content = rawText.substring(lastIndex, i).trim();
                                chunks.push({ time: lastTime, content: content });
                            }

                            lastTime = currentTime;
                            lastIndex = i + 5; // Salta l'orario
                        }
                    }
                }

                // Aggiungi l'ultimo pezzo
                if (lastTime !== null) {
                    let content = rawText.substring(lastIndex).trim();
                    chunks.push({ time: lastTime, content: content });
                }

                if (chunks.length === 0) {
                    throw new Error("Nessun orario 00:00 trovato.");
                }

                // 3. Elabora i blocchi per trovare Titolo/Autore (Sempre senza Regex)
                const tracks = [];
                let idCounter = 1;

                for (let chunk of chunks) {
                    let content = chunk.content;
                    if (content.length < 2) continue;

                    let trackTitle = "Capitolo " + idCounter;
                    let trackAuthor = "";
                    let trackDesc = content;

                    // Cerca "Titolo Opera:"
                    let tagTitolo = "Titolo Opera:";
                    let tagAutore = "Autore dell'Opera:";
                    
                    let idxTitolo = content.indexOf(tagTitolo);
                    let idxAutore = content.indexOf(tagAutore);

                    if (idxTitolo !== -1 && idxAutore !== -1) {
                        // Estrai Titolo
                        let startT = idxTitolo + tagTitolo.length;
                        trackTitle = content.substring(startT, idxAutore).trim();
                        // Rimuovi virgola finale se presente
                        if(trackTitle.endsWith(',')) trackTitle = trackTitle.slice(0, -1);

                        // Estrai Autore
                        let startA = idxAutore + tagAutore.length;
                        // Cerchiamo la fine della riga o un punto per l'autore
                        // Assumiamo che la descrizione inizi dopo l'autore. Spesso c'√® un "a capo" o il testo continua.
                        // Nel file fornito l'autore √® seguito dal testo. Cerchiamo di isolarlo.
                        // Prendiamo tutto il resto come descrizione per ora, poi puliamo.
                        let rest = content.substring(startA).trim();
                        
                        // Semplificazione: L'autore finisce spesso dove inizia una frase maiuscola o dopo un po'.
                        // Per non complicare, mettiamo l'autore nel campo e puliamo la descrizione
                        // In questo formato specifico, l'autore √® solitamente corto.
                        // Cerchiamo il primo punto o a capo.
                        let endLine = rest.indexOf("\n");
                        if (endLine === -1) endLine = 50; // Fallback
                        trackAuthor = rest.substring(0, endLine).trim();
                        trackDesc = rest.substring(endLine).trim();

                    } else if (content.toLowerCase().indexOf("introduzione") !== -1) {
                        trackTitle = "Introduzione";
                    }

                    // Pulizia "Fine Descrizione" (Manuale)
                    let fineTag = "Fine Descrizione";
                    let idxFine = trackDesc.indexOf(fineTag);
                    if (idxFine !== -1) trackDesc = trackDesc.substring(0, idxFine).trim();

                    let fineIntro = "Fine Introduzione";
                    let idxIntroFine = trackDesc.indexOf(fineIntro);
                    if (idxIntroFine !== -1) trackDesc = trackDesc.substring(0, idxIntroFine).trim();

                    tracks.push({
                        id: idCounter++,
                        time: chunk.time,
                        seconds: this.timeToSec(chunk.time),
                        title: trackTitle,
                        author: trackAuthor,
                        desc: trackDesc
                    });
                }

                // Generazione File
                const guideData = {
                    title: title,
                    mp3File: mp3,
                    generated: new Date().toISOString(),
                    tracks: tracks
                };

                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(guideData, null, 2));
                const link = document.createElement('a');
                link.href = dataStr;
                link.download = title.replace(/[^a-z0-9]/gi, '_').toLowerCase() + ".json";
                document.body.appendChild(link);
                link.click();
                link.remove();

                status.innerHTML = `<span style='color:green'>‚úÖ File creato (${tracks.length} tracce)!</span>`;

            } catch (err) {
                console.error(err);
                status.innerHTML = `<span style='color:red'>Errore: ${err.message}</span>`;
            }
        },

        loadRemoteGuide: function(file) {
            if(!file) return;
            fetch(file)
                .then(r => r.json())
                .then(d => this.loadData(d))
                .catch(e => alert("Errore fetch: " + e));
        },

        loadLocalJson: function(input) {
            const file = input.files[0];
            if(!file) return;
            const r = new FileReader();
            r.onload = (e) => {
                try {
                    this.loadData(JSON.parse(e.target.result));
                } catch(err) { alert("JSON non valido"); }
            };
            r.readAsText(file);
        },

        loadData: function(data) {
            document.getElementById('audioPlayer').src = data.mp3File;
            this.currentTracks = data.tracks;
            this.renderList(this.currentTracks);
            document.getElementById('trackLabel').innerText = "Guida caricata: " + data.title;
        },

        renderList: function(tracks) {
            const list = document.getElementById('trackList');
            list.innerHTML = "";
            
            if(tracks.length === 0) {
                list.innerHTML = "<div style='padding:20px; text-align:center'>Nessun risultato</div>";
                return;
            }

            tracks.forEach(t => {
                const li = document.createElement('li');
                li.className = "track-card";
                li.dataset.sec = t.seconds;
                li.onclick = () => {
                    const p = document.getElementById('audioPlayer');
                    p.currentTime = t.seconds;
                    p.play();
                    this.updateUI(t);
                };
                li.innerHTML = `
                    <div class="card-top">
                        <span>${t.title}</span>
                        <span class="t-time">${t.time}</span>
                    </div>
                    ${t.author ? `<div style="font-style:italic; color:#b71c1c; font-size:0.9rem; margin-bottom:5px">${t.author}</div>` : ''}
                    <div style="font-size:0.9rem; color:#555;">${t.desc}</div>
                `;
                list.appendChild(li);
            });
        },

        updateUI: function(track) {
            document.getElementById('trackLabel').innerText = `${track.time} - ${track.title}`;
            document.querySelectorAll('.track-card').forEach(c => c.classList.remove('active'));
            const active = document.querySelector(`.track-card[data-sec="${track.seconds}"]`);
            if(active) {
                active.classList.add('active');
                active.scrollIntoView({behavior:"smooth", block:"center"});
            }
        },

        search: function(q) {
            const term = q.toLowerCase();
            const filtered = this.currentTracks.filter(t => 
                t.title.toLowerCase().includes(term) || 
                (t.author && t.author.toLowerCase().includes(term)) ||
                t.desc.toLowerCase().includes(term)
            );
            this.renderList(filtered);
        },

        timeToSec: function(str) {
            const p = str.split(':');
            return parseInt(p[0])*60 + parseInt(p[1]);
        }
    };

    document.addEventListener('DOMContentLoaded', () => {
        const guides = [];
        const sel = document.getElementById('guideSelector');
        guides.forEach(g => {
            const opt = document.createElement('option');
            opt.value = g.file;
            opt.textContent = g.name;
            sel.appendChild(opt);
        });

        const player = document.getElementById('audioPlayer');
        player.addEventListener('timeupdate', () => {
            const cur = player.currentTime;
            const track = [...window.app.currentTracks].reverse().find(t => t.seconds <= cur + 1);
            if(track) window.app.updateUI(track);
        });
    });
</script>

</body>
</html>
