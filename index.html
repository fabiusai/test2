<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audioguida Galleria dell'Accademia</title>
    <style>
        :root {
            --primary: #8B0000;
            --secondary: #F5F5DC;
            --text: #333;
            --active-bg: #ffe0b2;
        }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { margin: 0; background-color: var(--secondary); color: var(--text); padding-bottom: 140px; }
        
        header { background: var(--primary); color: white; padding: 1rem; text-align: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        h1 { margin: 0; font-size: 1.2rem; }
        
        .container { max-width: 800px; margin: 0 auto; padding: 15px; }
        
        /* Ricerca */
        .search-container { position: sticky; top: 60px; background: var(--secondary); z-index: 90; padding: 10px 0; }
        #searchInput { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; }
        
        /* Lista */
        .track-list { list-style: none; padding: 0; }
        .track-card { background: white; border-radius: 8px; padding: 15px; margin-bottom: 10px; cursor: pointer; border-left: 5px solid transparent; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .track-card:hover { transform: translateY(-2px); }
        .track-card.active { border-left-color: var(--primary); background-color: var(--active-bg); }
        
        .track-header { display: flex; justify-content: space-between; font-weight: bold; color: var(--primary); margin-bottom: 5px; }
        .track-time { background: #eee; color: #333; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; }
        .track-excerpt { font-size: 0.9rem; color: #555; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        /* Player */
        .fixed-player { position: fixed; bottom: 0; left: 0; width: 100%; background: white; padding: 10px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); text-align: center; z-index: 1000; }
        .player-info { margin-bottom: 5px; font-weight: bold; color: var(--primary); font-size: 0.9rem; }
        audio { width: 100%; max-width: 800px; }
        
        #error-msg { color: red; text-align: center; padding: 20px; display: none; background: white; margin-top: 10px; border-radius: 8px; }
    </style>
</head>
<body>

<header>
    <h1>Galleria dell'Accademia</h1>
    <div style="font-size: 0.9rem; opacity: 0.9;">Firenze - Audioguida</div>
</header>

<div class="container">
    <div class="search-container">
        <input type="text" id="searchInput" placeholder="Cerca opera o autore...">
    </div>
    
    <div id="error-msg"></div>
    <div id="loading" style="text-align:center; margin-top:20px;">Caricamento audioguida...</div>
    <ul class="track-list" id="trackList"></ul>
</div>

<div class="fixed-player">
    <div class="player-info" id="currentTrackLabel">Seleziona un'opera</div>
    <audio id="audioPlayer" controls controlsList="nodownload">
        <source src="Galleria_dell'Accademia_di_Firenze.mp3" type="audio/mpeg">
    </audio>
</div>

<script>
    // NOME DEI FILE - Devono essere identici a quelli caricati su GitHub
    const TXT_FILE = "Galleria_dell'Accademia_di_Firenze.txt";
    
    let allTracks = [];
    const player = document.getElementById('audioPlayer');
    const list = document.getElementById('trackList');
    const label = document.getElementById('currentTrackLabel');
    const errorMsg = document.getElementById('error-msg');

    // Caricamento Dati
    fetch(TXT_FILE)
        .then(res => {
            if (!res.ok) throw new Error(`Impossibile leggere il file ${TXT_FILE} (Errore ${res.status})`);
            return res.text();
        })
        .then(text => processData(text))
        .catch(err => {
            document.getElementById('loading').style.display = 'none';
            errorMsg.style.display = 'block';
            errorMsg.innerHTML = `<strong>Errore:</strong> ${err.message}<br>Assicurati che il file .txt sia caricato nella repository.`;
        });

    function processData(text) {
        document.getElementById('loading').style.display = 'none';
        
        // Rimuove tag source e fa parsing
        const cleanText = text.replace(/\/g, "");
        const regex = /(\d{2}:\d{2})([\s\S]*?)(?=(\d{2}:\d{2})|$)/g;
        
        let match;
        while ((match = regex.exec(cleanText)) !== null) {
            const time = match[1];
            const content = match[2].trim();
            
            // Estrazione metadati
            let title = "Introduzione";
            let author = "";
            let desc = content;
            
            // Cerca pattern Titolo/Autore
            const meta = content.match(/Titolo Opera:\s*(.*?)\s*Autore dell'Opera:\s*(.*?)\s([\s\S]*)/i);
            if (meta) {
                title = meta[1].trim();
                author = meta[2].trim();
                desc = meta[3].replace(/Fine Descrizione.*/i, "").trim();
            } else if (content.toLowerCase().includes("introduzione")) {
                title = "Introduzione";
                desc = content.replace(/Fine Introduzione.*/i, "").trim();
            }

            if (desc.length > 5) {
                allTracks.push({ 
                    seconds: timeToSec(time), 
                    displayTime: time, 
                    title, author, desc 
                });
            }
        }
        render(allTracks);
    }

    function render(tracks) {
        list.innerHTML = "";
        tracks.forEach(t => {
            const li = document.createElement('li');
            li.className = "track-card";
            li.dataset.sec = t.seconds;
            li.onclick = () => {
                player.currentTime = t.seconds;
                player.play();
                updateActive(t);
            };
            li.innerHTML = `
                <div class="track-header">
                    <span>${t.title}</span>
                    <span class="track-time">${t.displayTime}</span>
                </div>
                ${t.author ? `<div style="font-size:0.9rem; color:#666; margin-bottom:5px;"><i>${t.author}</i></div>` : ''}
                <div class="track-excerpt">${t.desc}</div>
            `;
            list.appendChild(li);
        });
    }

    function timeToSec(str) {
        const p = str.split(':');
        return parseInt(p[0])*60 + parseInt(p[1]);
    }

    function updateActive(track) {
        label.textContent = `${track.displayTime} - ${track.title}`;
        document.querySelectorAll('.track-card').forEach(c => c.classList.remove('active'));
        const active = document.querySelector(`.track-card[data-sec="${track.seconds}"]`);
        if(active) {
            active.classList.add('active');
            active.scrollIntoView({behavior: "smooth", block: "center"});
        }
    }

    // Sync Audio -> Scroll
    player.addEventListener('timeupdate', () => {
        const cur = player.currentTime;
        const track = allTracks.slice().reverse().find(t => t.seconds <= cur + 1);
        if(track) {
            const active = document.querySelector(`.track-card[data-sec="${track.seconds}"]`);
            if(active && !active.classList.contains('active')) updateActive(track);
        }
    });

    // Ricerca
    document.getElementById('searchInput').addEventListener('input', (e) => {
        const q = e.target.value.toLowerCase();
        const filtered = allTracks.filter(t => 
            t.title.toLowerCase().includes(q) || 
            t.author.toLowerCase().includes(q) || 
            t.desc.toLowerCase().includes(q)
        );
        render(filtered);
    });
</script>

</body>
</html>
