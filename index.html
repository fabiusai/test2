<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audioguide Player Pro 0.2</title>
    <style>
        :root {
            --primary: #b71c1c;
            --bg-color: #f4f4f4;
            --card-bg: #ffffff;
            --text-main: #212121;
            --border: #ddd;
        }

        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        body { margin: 0; background-color: var(--bg-color); color: var(--text-main); padding-bottom: 150px; }

        /* HEADER */
        header {
            background: white; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: sticky; top: 0; z-index: 100;
        }
        .header-content { max-width: 800px; margin: 0 auto; display: flex; flex-direction: column; gap: 15px; }
        
        .top-row { display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 1.3rem; color: var(--primary); }

        /* BOTTONI TOOLBAR */
        .btn-tool {
            background: #eee; border: 1px solid #ccc; padding: 8px 12px; border-radius: 6px; 
            cursor: pointer; font-size: 0.9rem; font-weight: 600;
        }
        .btn-tool:hover { background: #e0e0e0; }
        
        /* AREA CONTROLLI */
        .controls-row { display: flex; gap: 10px; }
        select#guideSelector { flex: 1; padding: 10px; border-radius: 6px; border: 1px solid #ccc; }
        
        .upload-btn-wrapper { position: relative; overflow: hidden; display: inline-block; }
        .btn-upload { 
            border: 1px solid var(--primary); background: white; color: var(--primary); 
            padding: 10px 15px; border-radius: 6px; font-weight: bold; cursor: pointer; 
        }
        .upload-btn-wrapper input[type=file] { 
            font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; 
        }

        /* RICERCA */
        .search-row { margin-top: 10px; }
        #searchInput { width: 100%; padding: 12px; border-radius: 20px; border: 1px solid #ccc; outline: none; }
        #searchInput:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(183,28,28,0.1); }

        /* LISTA TRACCE */
        .container { max-width: 800px; margin: 0 auto; padding: 15px; }
        .track-list { list-style: none; padding: 0; margin: 0; }
        
        .track-card {
            background: var(--card-bg); border-radius: 8px; padding: 15px; margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; border-left: 4px solid transparent;
            transition: transform 0.2s;
        }
        .track-card:hover { transform: translateY(-2px); }
        .track-card.active { border-left-color: var(--primary); background-color: #fffde7; }

        .card-top { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .t-title { font-weight: bold; font-size: 1.1rem; color: #333; }
        .t-time { background: #eee; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; height: fit-content; font-weight: bold;}
        .t-auth { font-style: italic; color: var(--primary); font-size: 0.9rem; margin-bottom: 5px; }
        .t-desc { font-size: 0.95rem; color: #555; line-height: 1.5; }

        /* PLAYER FISSO */
        .player-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; background: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1); padding: 15px; text-align: center; z-index: 1000;
        }
        .now-playing { font-weight: bold; color: var(--primary); margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        audio { width: 100%; max-width: 800px; }

        /* MODALE */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center;
        }
        .modal-box {
            background: white; width: 90%; max-width: 600px; padding: 20px; border-radius: 10px;
            max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; gap: 15px;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px;}
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; }
        
        .form-group label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.9rem; }
        .form-group input, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        .form-group textarea { height: 150px; font-family: monospace; resize: vertical; }
        
        .btn-primary { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-size: 1rem; width: 100%; }
        
        .status-msg { text-align: center; font-size: 0.9rem; margin-top: 10px; }
        .empty-msg { text-align: center; padding: 40px; color: #888; }
    </style>
</head>
<body>

<header>
    <div class="header-content">
        <div class="top-row">
            <h1 id="appTitle">Audioguide Player</h1>
            <button id="btnOpenCreator" class="btn-tool">‚öôÔ∏è Crea Guida</button>
        </div>
        
        <div class="controls-row">
            <select id="guideSelector">
                <option value="" disabled selected>-- Scegli Guida --</option>
            </select>

            <div class="upload-btn-wrapper">
                <button class="btn-upload">üìÇ Apri JSON</button>
                <input type="file" id="jsonInput" accept=".json">
            </div>
        </div>

        <div class="search-row">
            <input type="text" id="searchInput" placeholder="üîç Cerca opera o autore...">
        </div>
    </div>
</header>

<div class="container">
    <ul id="trackList" class="track-list">
        <div class="empty-msg">
            Nessuna guida caricata.<br><br>
            Usa <strong>"Apri JSON"</strong> per caricare un file locale.<br>
            Usa <strong>"Crea Guida"</strong> per convertire un testo in JSON.
        </div>
    </ul>
</div>

<div class="player-bar">
    <div id="trackLabel" class="now-playing">Seleziona una traccia</div>
    <audio id="audioPlayer" controls controlsList="nodownload"></audio>
</div>

<div id="creatorModal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header">
            <h3>Convertitore TXT ‚Üí JSON</h3>
            <button id="btnCloseModal" class="close-btn">√ó</button>
        </div>

        <div class="form-group">
            <label>1. Titolo Guida</label>
            <input type="text" id="newGuideTitle" placeholder="Es: Uffizi">
        </div>
        <div class="form-group">
            <label>2. Nome File MP3 (Esatto)</label>
            <input type="text" id="newMp3Name" placeholder="Es: uffizi.mp3">
        </div>
        <div class="form-group">
            <label>3. Testo Audioguida</label>
            <textarea id="txtContent" placeholder="Incolla qui il testo con i timestamp..."></textarea>
            <div style="text-align: right; margin-top: 5px;">
                <button id="btnLoadTxtFile" class="btn-tool" style="font-size:0.8rem">O carica file .txt</button>
                <input type="file" id="txtFileInput" accept=".txt" style="display:none">
            </div>
        </div>

        <button id="btnDownloadJson" class="btn-primary">üíæ Scarica JSON</button>
        <div id="convertStatus" class="status-msg"></div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        
        // --- CONFIGURAZIONE GUIDE REMOTE ---
        const AVAILABLE_GUIDES = [
            // { name: "Galleria Accademia", file: "accademia.json" }
        ];

        // --- DOM REFERENCES ---
        const btnOpenCreator = document.getElementById('btnOpenCreator');
        const btnCloseModal = document.getElementById('btnCloseModal');
        const btnDownloadJson = document.getElementById('btnDownloadJson');
        const btnLoadTxtFile = document.getElementById('btnLoadTxtFile');
        const creatorModal = document.getElementById('creatorModal');
        
        const jsonInput = document.getElementById('jsonInput');
        const txtFileInput = document.getElementById('txtFileInput');
        
        const player = document.getElementById('audioPlayer');
        const listEl = document.getElementById('trackList');
        const trackLabel = document.getElementById('trackLabel');
        const appTitle = document.getElementById('appTitle');
        const searchInput = document.getElementById('searchInput');
        const guideSelector = document.getElementById('guideSelector');

        const inputTitle = document.getElementById('newGuideTitle');
        const inputMp3 = document.getElementById('newMp3Name');
        const inputText = document.getElementById('txtContent');
        const statusMsg = document.getElementById('convertStatus');

        let currentTracks = [];

        // --- EVENT LISTENERS ---

        // 1. Modale
        if(btnOpenCreator) {
            btnOpenCreator.addEventListener('click', () => {
                creatorModal.style.display = 'flex';
                statusMsg.textContent = '';
            });
        }

        if(btnCloseModal) {
            btnCloseModal.addEventListener('click', () => {
                creatorModal.style.display = 'none';
            });
        }
        
        window.addEventListener('click', (e) => {
            if (e.target === creatorModal) creatorModal.style.display = 'none';
        });

        // 2. Carica TXT in textarea
        if(btnLoadTxtFile) {
            btnLoadTxtFile.addEventListener('click', () => txtFileInput.click());
        }

        if(txtFileInput) {
            txtFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => inputText.value = ev.target.result;
                reader.readAsText(file);
            });
        }

        // 3. Genera e Scarica JSON
        if(btnDownloadJson) {
            btnDownloadJson.addEventListener('click', () => {
                const rawText = inputText.value;
                const title = inputTitle.value || "Nuova Audioguida";
                const mp3 = inputMp3.value || "audio.mp3";

                if (!rawText.trim()) {
                    statusMsg.innerHTML = "<span style='color:red'>Errore: Manca il testo!</span>";
                    return;
                }

                const tracks = parseText(rawText);

                if (tracks.length === 0) {
                    statusMsg.innerHTML = "<span style='color:red'>Nessun timestamp (00:00) trovato.</span>";
                    return;
                }

                const guideData = {
                    title: title,
                    mp3File: mp3,
                    generated: new Date().toISOString(),
                    tracks: tracks
                };

                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(guideData, null, 2));
                const link = document.createElement('a');
                link.href = dataStr;
                link.download = title.replace(/[^a-z0-9]/gi, '_').toLowerCase() + ".json";
                document.body.appendChild(link);
                link.click();
                link.remove();

                statusMsg.innerHTML = `<span style='color:green'>‚úÖ JSON Salvato! (${tracks.length} tracce)</span>`;
            });
        }

        // 4. Carica JSON nel Player
        if(jsonInput) {
            jsonInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const data = JSON.parse(ev.target.result);
                        loadGuideToPlayer(data);
                        guideSelector.value = ""; 
                    } catch(err) {
                        alert("File JSON non valido");
                    }
                };
                reader.readAsText(file);
            });
        }

        // 5. Select Guide
        if(guideSelector) {
            if(AVAILABLE_GUIDES.length > 0) {
                AVAILABLE_GUIDES.forEach(g => {
                    const opt = document.createElement('option');
                    opt.value = g.file;
                    opt.textContent = g.name;
                    guideSelector.appendChild(opt);
                });
            } else {
                const opt = document.createElement('option');
                opt.textContent = "Nessuna guida remota";
                guideSelector.appendChild(opt);
            }

            guideSelector.addEventListener('change', (e) => {
                const file = e.target.value;
                if(!file || file.includes("Nessuna")) return;

                fetch(file)
                    .then(res => {
                        if(!res.ok) throw new Error("File non trovato");
                        return res.json();
                    })
                    .then(data => loadGuideToPlayer(data))
                    .catch(err => alert("Errore caricamento: " + err.message));
            });
        }

        // 6. Ricerca
        if(searchInput) {
            searchInput.addEventListener('input', (e) => {
                const q = e.target.value.toLowerCase();
                if(!currentTracks.length) return;
                
                const filtered = currentTracks.filter(t => 
                    t.title.toLowerCase().includes(q) || 
                    (t.author && t.author.toLowerCase().includes(q)) ||
                    t.desc.toLowerCase().includes(q)
                );
                renderList(filtered);
            });
        }

        // 7. Time Update
        player.addEventListener('timeupdate', () => {
            const cur = player.currentTime;
            const track = [...currentTracks].reverse().find(t => t.seconds <= cur + 1);
            if(track) updateActiveTrackUI(track);
        });

        /* --- CORE FUNCTIONS --- */

        function loadGuideToPlayer(data) {
            appTitle.textContent = data.title || "Audioguida";
            player.src = data.mp3File;
            currentTracks = data.tracks || [];
            renderList(currentTracks);
            player.load();
            trackLabel.textContent = "Guida caricata: " + (data.title);
        }

        function renderList(tracks) {
            listEl.innerHTML = '';
            if(tracks.length === 0) {
                listEl.innerHTML = '<div class="empty-msg">Nessuna traccia trovata.</div>';
                return;
            }

            tracks.forEach(t => {
                const li = document.createElement('li');
                li.className = 'track-card';
                li.dataset.sec = t.seconds;
                
                li.addEventListener('click', () => {
                    player.currentTime = t.seconds;
                    player.play().catch(e => console.log("Autoplay bloccato"));
                    updateActiveTrackUI(t);
                });

                li.innerHTML = `
                    <div class="card-top">
                        <span class="t-title">${t.title}</span>
                        <span class="t-time">${t.time}</span>
                    </div>
                    ${t.author ? `<div class="t-auth">${t.author}</div>` : ''}
                    <div class="t-desc">${t.desc}</div>
                `;
                listEl.appendChild(li);
            });
        }

        function updateActiveTrackUI(track) {
            trackLabel.textContent = `${track.time} - ${track.title}`;
            document.querySelectorAll('.track-card').forEach(c => c.classList.remove('active'));
            const activeCard = document.querySelector(`.track-card[data-sec="${track.seconds}"]`);
            if(activeCard) {
                activeCard.classList.add('active');
                activeCard.scrollIntoView({behavior: "smooth", block: "center"});
            }
        }

        function parseText(text) {
            // USIAMO new RegExp PER EVITARE ERRORI DI PARSING CON LE SLASH
            
            // 1. Rimuovi tag source
            const rxSource = new RegExp("\\", "g");
            const cleanText = text.replace(rxSource, "");
            
            // 2. Regex Principale (MM:SS)
            // Pattern: (\d{2}:\d{2})([\s\S]*?)(?=(\d{2}:\d{2})|$)
            const rxMain = new RegExp("(\\d{2}:\\d{2})([\\s\\S]*?)(?=(\\d{2}:\\d{2})|$)", "g");
            
            let match;
            const tracks = [];
            let id = 1;

            while ((match = rxMain.exec(cleanText)) !== null) {
                const timeStr = match[1];
                const content = match[2].trim();
                
                let title = "Capitolo " + id;
                let author = "";
                let desc = content;

                // 3. Regex Metadati (Titolo/Autore)
                // Pattern: Titolo Opera:\s*(.*?)\s*Autore dell'Opera:\s*(.*?)\s([\s\S]*)
                const rxMeta = new RegExp("Titolo Opera:\\s*(.*?)\\s*Autore dell'Opera:\\s*(.*?)\\s([\\s\\S]*)", "i");
                const meta = content.match(rxMeta);
                
                if (meta) {
                    title = meta[1].trim();
                    author = meta[2].trim();
                    desc = meta[3];
                } else if (content.toLowerCase().includes("introduzione")) {
                    title = "Introduzione";
                }

                // 4. Pulizia Descrizione (Regex)
                const rxCleanDesc = new RegExp("Fine Descrizione.*", "i");
                const rxCleanIntro = new RegExp("Fine Introduzione.*", "i");
                
                desc = desc.replace(rxCleanDesc, "").replace(rxCleanIntro, "").trim();

                if (desc.length > 2) {
                    tracks.push({
                        id: id++,
                        time: timeStr,
                        seconds: timeToSeconds(timeStr),
                        title: title,
                        author: author,
                        desc: desc
                    });
                }
            }
            return tracks;
        }

        function timeToSeconds(str) {
            const p = str.split(':');
            return parseInt(p[0]) * 60 + parseInt(p[1]);
        }

    });
</script>

</body>
</html>
